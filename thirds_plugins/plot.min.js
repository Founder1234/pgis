var P={version:"1.0.0"};function expose(){var t=window.P;P.noConflict=function(){window.P=t;return this};window.P=P}if(typeof module==="object"&&typeof module.exports==="object"){module.exports=P}else if(typeof define==="function"&&define.amd){define(P)}if(typeof window!=="undefined"){expose()}P.Constants={TWO_PI:Math.PI*2,HALF_PI:Math.PI/2,FITTING_COUNT:100,ZERO_TOLERANCE:1e-4},P.Utils={_stampId:0},P.Utils.trim=function(t){return t.trim?t.trim():t.replace(/^\s+|\s+$/g,"")},P.Utils.stamp=function(t){var e="_p_id_";t[e]=t[e]||this._stampId++;return t[e]},P.DomUtils={},P.DomUtils.create=function(t,e,o,i){var s=document.createElement(t);s.className=e||"";if(i){s.id=i}if(o){o.appendChild(s)}return s},P.DomUtils.createHidden=function(t,e,o){var i=document.createElement(t);i.style.display="none";if(o){i.id=o}if(e){e.appendChild(i)}return i},P.DomUtils.remove=function(t,e){if(e&&t){e.removeChild(t)}},P.DomUtils.get=function(t){return document.getElementById(t)},P.DomUtils.getStyle=function(t,e){var o=t.style[e];return o==="auto"?null:o},P.DomUtils.hasClass=function(t,e){return t.className.length>0&&new RegExp("(^|\\s)"+e+"(\\s|$)").test(t.className)},P.DomUtils.addClass=function(t,e){if(this.hasClass(t,e)){return}if(t.className){t.className+=" "}t.className+=e},P.DomUtils.removeClass=function(t,e){t.className=P.Utils.trim((" "+t.className+" ").replace(" "+e+" "," "))},P.DomUtils.getDomEventKey=function(t,e,o){return"_p_dom_event_"+t+"_"+P.Utils.stamp(e)+(o?"_"+P.Utils.stamp(o):"")},P.DomUtils.addListener=function(t,e,o,i){var s=this,r=P.DomUtils.getDomEventKey(e,o,i),n=t[r];if(n){return s}n=function(e){return o.call(i||t,e)};if("addEventListener"in t){t.addEventListener(e,n,false)}else if("attachEvent"in t){t.attachEvent("on"+e,n)}t[r]=n;return s},P.DomUtils.removeListener=function(t,e,o,i){var s=this,r=P.DomUtils.getDomEventKey(e,o,i),n=t[r];if(!n){return s}if("removeEventListener"in t){t.removeEventListener(e,n,false)}else if("detachEvent"in t){t.detachEvent("on"+e,n)}t[r]=null;return s},P.PlotTypes={ARC:"arc",ELLIPSE:"ellipse",CURVE:"curve",CLOSED_CURVE:"closedcurve",LUNE:"lune",SECTOR:"sector",GATHERING_PLACE:"gatheringplace",STRAIGHT_ARROW:"straightarrow",ASSAULT_DIRECTION:"assaultdirection",ATTACK_ARROW:"attackarrow",TAILED_ATTACK_ARROW:"tailedattackarrow",SQUAD_COMBAT:"squadcombat",TAILED_SQUAD_COMBAT:"tailedsquadcombat",FINE_ARROW:"finearrow",CIRCLE:"circle",DOUBLE_ARROW:"doublearrow",POLYLINE:"polyline",FREEHAND_LINE:"freehandline",POLYGON:"polygon",FREEHAND_POLYGON:"freehandpolygon",RECTANGLE:"rectangle",POINT:"point",TRIANGLE:"triangle"},P.PlotUtils={},P.PlotUtils.distance=function(t,e){return Math.sqrt(Math.pow(t[0]-e[0],2)+Math.pow(t[1]-e[1],2))},P.PlotUtils.wholeDistance=function(t){var e=0;for(var o=0;o<t.length-1;o++)e+=P.PlotUtils.distance(t[o],t[o+1]);return e},P.PlotUtils.getBaseLength=function(t){return Math.pow(P.PlotUtils.wholeDistance(t),.99)},P.PlotUtils.mid=function(t,e){return[(t[0]+e[0])/2,(t[1]+e[1])/2]},P.PlotUtils.getCircleCenterOfThreePoints=function(t,e,o){var i=[(t[0]+e[0])/2,(t[1]+e[1])/2];var s=[i[0]-t[1]+e[1],i[1]+t[0]-e[0]];var r=[(t[0]+o[0])/2,(t[1]+o[1])/2];var n=[r[0]-t[1]+o[1],r[1]+t[0]-o[0]];return P.PlotUtils.getIntersectPoint(i,s,r,n)},P.PlotUtils.getIntersectPoint=function(t,e,o,i){if(t[1]==e[1]){var s=(i[0]-o[0])/(i[1]-o[1]);var r=s*(t[1]-o[1])+o[0];var n=t[1];return[r,n]}if(o[1]==i[1]){var l=(e[0]-t[0])/(e[1]-t[1]);r=l*(o[1]-t[1])+t[0];n=o[1];return[r,n]}l=(e[0]-t[0])/(e[1]-t[1]);s=(i[0]-o[0])/(i[1]-o[1]);n=(l*t[1]-t[0]-s*o[1]+o[0])/(l-s);r=l*n-l*t[1]+t[0];return[r,n]},P.PlotUtils.getAzimuth=function(t,e){var o;var i=Math.asin(Math.abs(e[1]-t[1])/P.PlotUtils.distance(t,e));if(e[1]>=t[1]&&e[0]>=t[0])o=i+Math.PI;else if(e[1]>=t[1]&&e[0]<t[0])o=P.Constants.TWO_PI-i;else if(e[1]<t[1]&&e[0]<t[0])o=i;else if(e[1]<t[1]&&e[0]>=t[0])o=Math.PI-i;return o},P.PlotUtils.getAngleOfThreePoints=function(t,e,o){var i=P.PlotUtils.getAzimuth(e,t)-P.PlotUtils.getAzimuth(e,o);return i<0?i+P.Constants.TWO_PI:i},P.PlotUtils.isClockWise=function(t,e,o){return(o[1]-t[1])*(e[0]-t[0])>(e[1]-t[1])*(o[0]-t[0])},P.PlotUtils.getPointOnLine=function(t,e,o){var i=e[0]+t*(o[0]-e[0]);var s=e[1]+t*(o[1]-e[1]);return[i,s]},P.PlotUtils.getCubicValue=function(t,e,o,i,s){t=Math.max(Math.min(t,1),0);var r=1-t;var n=t*t;var l=n*t;var a=r*r;var P=a*r;var h=P*e[0]+3*a*t*o[0]+3*r*n*i[0]+l*s[0];var p=P*e[1]+3*a*t*o[1]+3*r*n*i[1]+l*s[1];return[h,p]},P.PlotUtils.getThirdPoint=function(t,e,o,i,s){var r=P.PlotUtils.getAzimuth(t,e);var n=s?r+o:r-o;var l=i*Math.cos(n);var a=i*Math.sin(n);return[e[0]+l,e[1]+a]},P.PlotUtils.getArcPoints=function(t,e,o,i){var s,r,n=[];var l=i-o;l=l<0?l+P.Constants.TWO_PI:l;for(var a=0;a<=P.Constants.FITTING_COUNT;a++){var h=o+l*a/P.Constants.FITTING_COUNT;s=t[0]+e*Math.cos(h);r=t[1]+e*Math.sin(h);n.push([s,r])}return n},P.PlotUtils.getBisectorNormals=function(t,e,o,i){var s=P.PlotUtils.getNormal(e,o,i);var r=Math.sqrt(s[0]*s[0]+s[1]*s[1]);var n=s[0]/r;var l=s[1]/r;var a=P.PlotUtils.distance(e,o);var h=P.PlotUtils.distance(o,i);if(r>P.Constants.ZERO_TOLERANCE){if(P.PlotUtils.isClockWise(e,o,i)){var p=t*a;var c=o[0]-p*l;var u=o[1]+p*n;var v=[c,u];p=t*h;c=o[0]+p*l;u=o[1]-p*n;var g=[c,u]}else{p=t*a;c=o[0]+p*l;u=o[1]-p*n;v=[c,u];p=t*h;c=o[0]-p*l;u=o[1]+p*n;g=[c,u]}}else{c=o[0]+t*(e[0]-o[0]);u=o[1]+t*(e[1]-o[1]);v=[c,u];c=o[0]+t*(i[0]-o[0]);u=o[1]+t*(i[1]-o[1]);g=[c,u]}return[v,g]},P.PlotUtils.getNormal=function(t,e,o){var i=t[0]-e[0];var s=t[1]-e[1];var r=Math.sqrt(i*i+s*s);i/=r;s/=r;var n=o[0]-e[0];var l=o[1]-e[1];var a=Math.sqrt(n*n+l*l);n/=a;l/=a;var P=i+n;var h=s+l;return[P,h]},P.PlotUtils.getCurvePoints=function(t,e){var o=P.PlotUtils.getLeftMostControlPoint(e);var i=[o];for(var s=0;s<e.length-2;s++){var r=e[s];var n=e[s+1];var l=e[s+2];var a=P.PlotUtils.getBisectorNormals(t,r,n,l);i=i.concat(a)}var h=P.PlotUtils.getRightMostControlPoint(e);i.push(h);var p=[];for(s=0;s<e.length-1;s++){r=e[s];n=e[s+1];p.push(r);for(var t=0;t<P.Constants.FITTING_COUNT;t++){var c=P.PlotUtils.getCubicValue(t/P.Constants.FITTING_COUNT,r,i[s*2],i[s*2+1],n);p.push(c)}p.push(n)}return p},P.PlotUtils.getLeftMostControlPoint=function(e){var o=e[0];var i=e[1];var s=e[2];var r=P.PlotUtils.getBisectorNormals(0,o,i,s);var n=r[0];var l=P.PlotUtils.getNormal(o,i,s);var a=Math.sqrt(l[0]*l[0]+l[1]*l[1]);if(a>P.Constants.ZERO_TOLERANCE){var h=P.PlotUtils.mid(o,i);var p=o[0]-h[0];var c=o[1]-h[1];var u=P.PlotUtils.distance(o,i);var v=2/u;var g=-v*c;var d=v*p;var f=g*g-d*d;var y=2*g*d;var m=d*d-g*g;var T=n[0]-h[0];var E=n[1]-h[1];var C=h[0]+f*T+y*E;var A=h[1]+y*T+m*E}else{C=o[0]+t*(i[0]-o[0]);A=o[1]+t*(i[1]-o[1])}return[C,A]},P.PlotUtils.getRightMostControlPoint=function(e){var o=e.length;var i=e[o-3];var s=e[o-2];var r=e[o-1];var n=P.PlotUtils.getBisectorNormals(0,i,s,r);var l=n[1];var a=P.PlotUtils.getNormal(i,s,r);var h=Math.sqrt(a[0]*a[0]+a[1]*a[1]);if(h>P.Constants.ZERO_TOLERANCE){var p=P.PlotUtils.mid(s,r);var c=r[0]-p[0];var u=r[1]-p[1];var v=P.PlotUtils.distance(s,r);var g=2/v;var d=-g*u;var f=g*c;var y=d*d-f*f;var m=2*d*f;var T=f*f-d*d;var E=l[0]-p[0];var C=l[1]-p[1];var A=p[0]+y*E+m*C;var U=p[1]+m*E+T*C}else{A=r[0]+t*(s[0]-r[0]);U=r[1]+t*(s[1]-r[1])}return[A,U]},P.PlotUtils.getBezierPoints=function(t){if(t.length<=2)return t;var e=[];var o=t.length-1;for(var i=0;i<=1;i+=.01){var s=y=0;for(var r=0;r<=o;r++){var n=P.PlotUtils.getBinomialFactor(o,r);var l=Math.pow(i,r);var a=Math.pow(1-i,o-r);s+=n*l*a*t[r][0];y+=n*l*a*t[r][1]}e.push([s,y])}e.push(t[o]);return e},P.PlotUtils.getBinomialFactor=function(t,e){return P.PlotUtils.getFactorial(t)/(P.PlotUtils.getFactorial(e)*P.PlotUtils.getFactorial(t-e))},P.PlotUtils.getFactorial=function(t){if(t<=1)return 1;if(t==2)return 2;if(t==3)return 6;if(t==4)return 24;if(t==5)return 120;var e=1;for(var o=1;o<=t;o++)e*=o;return e},P.PlotUtils.getQBSplinePoints=function(t){if(t.length<=2)return t;var e=2;var o=[];var i=t.length-e-1;o.push(t[0]);for(var s=0;s<=i;s++){for(var r=0;r<=1;r+=.05){var n=y=0;for(var l=0;l<=e;l++){var a=P.PlotUtils.getQuadricBSplineFactor(l,r);n+=a*t[s+l][0];y+=a*t[s+l][1]}o.push([n,y])}}o.push(t[t.length-1]);return o},P.PlotUtils.getQuadricBSplineFactor=function(t,e){if(t==0)return Math.pow(e-1,2)/2;if(t==1)return(-2*Math.pow(e,2)+2*e+1)/2;if(t==2)return Math.pow(e,2)/2;return 0},P.Event={},P.Event.EventType={},P.Event.EventType.MOUSEMOVE="mousemove",P.Event.EventType.MOUSEUP="mouseup",P.Event.EventType.MOUSEDOWN="mousedown",P.Event.PlotDrawEvent=function(t,e){goog.base(this,t);this.plot=e.plot;this.feature=e.feature;this.plotType=e.plotType},goog.inherits(P.Event.PlotDrawEvent,ol.events.Event),P.Event.PlotDrawEvent.DRAW_START="draw_start",P.Event.PlotDrawEvent.DRAW_END="draw_end",P.Event.PlotEditEvent=function(t,e){goog.base(this,t);this.activePlot=e.activePlot},goog.inherits(P.Event.PlotEditEvent,ol.events.Event),P.Event.PlotEditEvent.EDIT_START="edit_start",P.Event.PlotEditEvent.EDIT_END="edit_end",P.PlotFill=function(t){goog.base(this,t)},goog.inherits(P.PlotFill,ol.style.Fill),P.PlotStroke=function(t){goog.base(this,t)},goog.inherits(P.PlotStroke,ol.style.Stroke),P.PlotStyle=function(t){goog.base(this,t)},goog.inherits(P.PlotStyle,ol.style.Style),P.PlotFeature=function(t){goog.base(this,t)},goog.inherits(P.PlotFeature,ol.Feature),P.PlotFeature.prototype.getFillColor=function(){var t=this.getStyle().getFill().getColor();var e=ol.color.asArray(t);return e.splice(0,e.length-1).join(",")},P.PlotFeature.prototype.getFillOpacity=function(){var t=this.getStyle().getFill().getColor();var e=ol.color.asArray(t);return e.splice(3,e.length).join(",")},P.PlotFeature.prototype.getStrokeColor=function(){var t=this.getStyle().getStroke().getColor();var e=ol.color.asArray(t);return e.splice(0,e.length-1).join(",")},P.PlotFeature.prototype.getStrokeOpacity=function(){var t=this.getStyle().getStroke().getColor();var e=ol.color.asArray(t);return e.splice(3,e.length).join(",")},P.PlotFeature.prototype.getStrokeWidth=function(){var t=this.getStyle().getStroke().getWidth();return t},P.PlotFeature.prototype.setFillColor=function(t){var e=ol.color.asArray(t);var o=ol.color.asArray(this.getStyle().getFill().getColor());e[3]=o[3];this.getStyle().getFill().setColor("rgba("+e.toString()+")")},P.PlotFeature.prototype.setFillOpacity=function(t){var e=ol.color.asArray(this.getStyle().getFill().getColor());e[3]=parseFloat(t);this.getStyle().getFill().setColor("rgba("+e.toString()+")")},P.PlotFeature.prototype.setStrokeColor=function(t){var e=ol.color.asArray(t);var o=ol.color.asArray(this.getStyle().getStroke().getColor());e[3]=o[3];this.getStyle().getStroke().setColor("rgba("+e.toString()+")")},P.PlotFeature.prototype.setStrokeOpacity=function(t){var e=ol.color.asArray(this.getStyle().getStroke().getColor());e[3]=parseFloat(t);this.getStyle().getStroke().setColor("rgba("+e.toString()+")")},P.PlotFeature.prototype.setStrokeWidth=function(t){this.getStyle().getStroke().setWidth(t)},P.Plot=function(t){this.setPoints(t)},P.Plot.prototype={isPlot:function(){return true},setPoints:function(t){this.points=t?t:[];if(this.points.length>=2)this.generate()},getPoints:function(){return this.points.slice(0)},getPointCount:function(){return this.points.length},updatePoint:function(t,e){if(e>=0&&e<this.points.length){this.points[e]=t;this.generate()}},updateLastPoint:function(t){this.updatePoint(t,this.points.length-1)},generate:function(){},finishDrawing:function(){},getPlotType:function(){return this.type}},P.Plot.Arc=function(t){goog.base(this,[]);this.type=P.PlotTypes.ARC;this.fixPointCount=3;this.setPoints(t)},goog.inherits(P.Plot.Arc,ol.geom.LineString),goog.mixin(P.Plot.Arc.prototype,P.Plot.prototype),P.Plot.Arc.prototype.generate=function(){var t=this.getPointCount();if(t<2)return;if(t==2)this.setCoordinates(this.points);else{var e=this.points[0];var o=this.points[1];var i=this.points[2];var s=P.PlotUtils.getCircleCenterOfThreePoints(e,o,i);var r=P.PlotUtils.distance(e,s);var n=P.PlotUtils.getAzimuth(e,s);var l=P.PlotUtils.getAzimuth(o,s);if(P.PlotUtils.isClockWise(e,o,i)){var a=l;var h=n}else{a=n;h=l}this.setCoordinates(P.PlotUtils.getArcPoints(s,r,a,h))}},P.Plot.AttackArrow=function(t){goog.base(this,[]);this.type=P.PlotTypes.ATTACK_ARROW;this.headHeightFactor=.16;this.headWidthFactor=.4;this.neckHeightFactor=.85;this.neckWidthFactor=.15;this.headTailFactor=.8;this.setPoints(t)},goog.inherits(P.Plot.AttackArrow,ol.geom.Polygon),goog.mixin(P.Plot.AttackArrow.prototype,P.Plot.prototype),P.Plot.AttackArrow.prototype.generate=function(){if(this.getPointCount()<2)return;if(this.getPointCount()==2){this.setCoordinates([this.points]);return}var t=this.getPoints();var e=t[0];var o=t[1];if(P.PlotUtils.isClockWise(t[0],t[1],t[2])){e=t[1];o=t[0]}var i=P.PlotUtils.mid(e,o);var s=[i].concat(t.slice(2));var r=this.getArrowHeadPoints(s,e,o);var n=r[0];var l=r[4];var a=P.PlotUtils.distance(e,o)/P.PlotUtils.getBaseLength(s);var h=this.getArrowBodyPoints(s,n,l,a);var p=h.length;var c=[e].concat(h.slice(0,p/2));c.push(n);var u=[o].concat(h.slice(p/2,p));u.push(l);c=P.PlotUtils.getQBSplinePoints(c);u=P.PlotUtils.getQBSplinePoints(u);this.setCoordinates([c.concat(r,u.reverse())])},P.Plot.AttackArrow.prototype.getArrowHeadPoints=function(t,e,o){var i=P.PlotUtils.getBaseLength(t);var s=i*this.headHeightFactor;var r=t[t.length-1];i=P.PlotUtils.distance(r,t[t.length-2]);var n=P.PlotUtils.distance(e,o);if(s>n*this.headTailFactor){s=n*this.headTailFactor}var l=s*this.headWidthFactor;var a=s*this.neckWidthFactor;s=s>i?i:s;var h=s*this.neckHeightFactor;var p=P.PlotUtils.getThirdPoint(t[t.length-2],r,0,s,true);var c=P.PlotUtils.getThirdPoint(t[t.length-2],r,0,h,true);var u=P.PlotUtils.getThirdPoint(r,p,P.Constants.HALF_PI,l,false);var v=P.PlotUtils.getThirdPoint(r,p,P.Constants.HALF_PI,l,true);var g=P.PlotUtils.getThirdPoint(r,c,P.Constants.HALF_PI,a,false);var d=P.PlotUtils.getThirdPoint(r,c,P.Constants.HALF_PI,a,true);return[g,u,r,v,d]},P.Plot.AttackArrow.prototype.getArrowBodyPoints=function(t,e,o,i){var s=P.PlotUtils.wholeDistance(t);var r=P.PlotUtils.getBaseLength(t);var n=r*i;var l=P.PlotUtils.distance(e,o);var a=(n-l)/2;var h=0,p=[],c=[];for(var u=1;u<t.length-1;u++){var v=P.PlotUtils.getAngleOfThreePoints(t[u-1],t[u],t[u+1])/2;h+=P.PlotUtils.distance(t[u-1],t[u]);var g=(n/2-h/s*a)/Math.sin(v);var d=P.PlotUtils.getThirdPoint(t[u-1],t[u],Math.PI-v,g,true);var f=P.PlotUtils.getThirdPoint(t[u-1],t[u],v,g,false);p.push(d);c.push(f)}return p.concat(c)},P.Plot.SquadCombat=function(t){goog.base(this,[]);this.type=P.PlotTypes.SQUAD_COMBAT;this.headHeightFactor=.18;this.headWidthFactor=.3;this.neckHeightFactor=.85;this.neckWidthFactor=.15;this.tailWidthFactor=.1;this.setPoints(t)},goog.inherits(P.Plot.SquadCombat,P.Plot.AttackArrow),P.Plot.SquadCombat.prototype.generate=function(){var t=this.getPoints();var e=this.getTailPoints(t);var o=this.getArrowHeadPoints(t,e[0],e[1]);var i=o[0];var s=o[4];var r=this.getArrowBodyPoints(t,i,s,this.tailWidthFactor);var n=r.length;var l=[e[0]].concat(r.slice(0,n/2));l.push(i);var a=[e[1]].concat(r.slice(n/2,n));a.push(s);l=P.PlotUtils.getQBSplinePoints(l);a=P.PlotUtils.getQBSplinePoints(a);this.setCoordinates([l.concat(o,a.reverse())])},P.Plot.SquadCombat.prototype.getTailPoints=function(t){var e=P.PlotUtils.getBaseLength(t);var o=e*this.tailWidthFactor;var i=P.PlotUtils.getThirdPoint(t[1],t[0],P.Constants.HALF_PI,o,false);var s=P.PlotUtils.getThirdPoint(t[1],t[0],P.Constants.HALF_PI,o,true);return[i,s]},P.Plot.TailedAttackArrow=function(t){goog.base(this,[]);this.type=P.PlotTypes.TAILED_ATTACK_ARROW;this.headHeightFactor=.18;this.headWidthFactor=.3;this.neckHeightFactor=.85;this.neckWidthFactor=.15;this.tailWidthFactor=.1;this.headTailFactor=.8;this.swallowTailFactor=1;this.swallowTailPnt=null;this.setPoints(t)},goog.inherits(P.Plot.TailedAttackArrow,P.Plot.AttackArrow),P.Plot.TailedAttackArrow.prototype.generate=function(){if(this.getPointCount()==2){this.setCoordinates([this.points]);return}var t=this.getPoints();var e=t[0];var o=t[1];if(P.PlotUtils.isClockWise(t[0],t[1],t[2])){e=t[1];o=t[0]}var i=P.PlotUtils.mid(e,o);var s=[i].concat(t.slice(2));var r=this.getArrowHeadPoints(s,e,o);var n=r[0];var l=r[4];var a=P.PlotUtils.distance(e,o);var h=P.PlotUtils.getBaseLength(s);var p=h*this.tailWidthFactor*this.swallowTailFactor;this.swallowTailPnt=P.PlotUtils.getThirdPoint(s[1],s[0],0,p,true);var c=a/h;var u=this.getArrowBodyPoints(s,n,l,c);var v=u.length;var g=[e].concat(u.slice(0,v/2));g.push(n);var d=[o].concat(u.slice(v/2,v));d.push(l);g=P.PlotUtils.getQBSplinePoints(g);d=P.PlotUtils.getQBSplinePoints(d);this.setCoordinates([g.concat(r,d.reverse(),[this.swallowTailPnt,g[0]])])},P.Plot.TailedSquadCombat=function(t){goog.base(this,[]);this.type=P.PlotTypes.TAILED_SQUAD_COMBAT;this.headHeightFactor=.18;this.headWidthFactor=.3;this.neckHeightFactor=.85;this.neckWidthFactor=.15;this.tailWidthFactor=.1;this.swallowTailFactor=1;this.swallowTailPnt=null;this.setPoints(t)},goog.inherits(P.Plot.TailedSquadCombat,P.Plot.AttackArrow),P.Plot.TailedSquadCombat.prototype.generate=function(){var t=this.getPoints();var e=this.getTailPoints(t);var o=this.getArrowHeadPoints(t,e[0],e[2]);var i=o[0];var s=o[4];var r=this.getArrowBodyPoints(t,i,s,this.tailWidthFactor);var n=r.length;var l=[e[0]].concat(r.slice(0,n/2));l.push(i);var a=[e[2]].concat(r.slice(n/2,n));a.push(s);l=P.PlotUtils.getQBSplinePoints(l);a=P.PlotUtils.getQBSplinePoints(a);this.setCoordinates([l.concat(o,a.reverse(),[e[1],l[0]])])},P.Plot.TailedSquadCombat.prototype.getTailPoints=function(t){var e=P.PlotUtils.getBaseLength(t);var o=e*this.tailWidthFactor;var i=P.PlotUtils.getThirdPoint(t[1],t[0],P.Constants.HALF_PI,o,false);var s=P.PlotUtils.getThirdPoint(t[1],t[0],P.Constants.HALF_PI,o,true);var r=o*this.swallowTailFactor;var n=P.PlotUtils.getThirdPoint(t[1],t[0],0,r,true);return[i,n,s]},P.Plot.Circle=function(t){goog.base(this,[]);this.type=P.PlotTypes.CIRCLE;this.fixPointCount=2;this.setPoints(t)},goog.inherits(P.Plot.Circle,ol.geom.Polygon),goog.mixin(P.Plot.Circle.prototype,P.Plot.prototype),P.Plot.Circle.prototype.generate=function(){var t=this.points[0];var e=P.PlotUtils.distance(t,this.points[1]);this.setCoordinates([this.generatePoints(t,e)])},P.Plot.Circle.prototype.generatePoints=function(t,e){var o,i,s,r=[];for(var n=0;n<=P.Constants.FITTING_COUNT;n++){s=Math.PI*2*n/P.Constants.FITTING_COUNT;o=t[0]+e*Math.cos(s);i=t[1]+e*Math.sin(s);r.push([o,i])}return r},P.Plot.ClosedCurve=function(t){goog.base(this,[]);this.type=P.PlotTypes.CLOSED_CURVE;this.t=.3;this.setPoints(t)},goog.inherits(P.Plot.ClosedCurve,ol.geom.Polygon),goog.mixin(P.Plot.ClosedCurve.prototype,P.Plot.prototype),P.Plot.ClosedCurve.prototype.generate=function(){if(this.getPointCount()==2)this.setCoordinates([this.points]);else{var t=this.getPoints();t.push(t[0],t[1]);var e=[];for(var o=0;o<t.length-2;o++){var i=P.PlotUtils.getBisectorNormals(this.t,t[o],t[o+1],t[o+2]);e=e.concat(i)}var s=e.length;e=[e[s-1]].concat(e.slice(0,s-1));var r=[];for(o=0;o<t.length-2;o++){var n=t[o];var l=t[o+1];r.push(n);for(var a=0;a<=P.Constants.FITTING_COUNT;a++){var h=P.PlotUtils.getCubicValue(a/P.Constants.FITTING_COUNT,n,e[o*2],e[o*2+1],l);r.push(h)}r.push(l)}this.setCoordinates([r])}},P.Plot.Curve=function(t){goog.base(this,[]);this.type=P.PlotTypes.CURVE;this.t=.3;this.setPoints(t)},goog.inherits(P.Plot.Curve,ol.geom.LineString),goog.mixin(P.Plot.Curve.prototype,P.Plot.prototype),P.Plot.Curve.prototype.generate=function(){if(this.getPointCount()==2)this.setCoordinates(this.points);else this.setCoordinates(P.PlotUtils.getCurvePoints(this.t,this.points))},P.Plot.DoubleArrow=function(t){goog.base(this,[]);this.type=P.PlotTypes.DOUBLE_ARROW;this.headHeightFactor=.25;this.headWidthFactor=.3;this.neckHeightFactor=.85;this.neckWidthFactor=.15;this.connPoint=null;this.tempPoint4=null;this.fixPointCount=4;this.setPoints(t)},goog.inherits(P.Plot.DoubleArrow,ol.geom.Polygon),goog.mixin(P.Plot.DoubleArrow.prototype,P.Plot.prototype),P.Plot.DoubleArrow.prototype.finishDrawing=function(){if(this.getPointCount()==3&&this.tempPoint4!=null)this.points.push(this.tempPoint4);if(this.connPoint!=null)this.points.push(this.connPoint)},P.Plot.DoubleArrow.prototype.generate=function(){if(this.getPointCount()==2){this.setCoordinates([this.points]);return}var t=this.points[0];var e=this.points[1];var o=this.points[2];var i=this.getPointCount();if(i==3)this.tempPoint4=this.getTempPoint4(t,e,o);else this.tempPoint4=this.points[3];if(i==3||i==4)this.connPoint=P.PlotUtils.mid(t,e);else this.connPoint=this.points[4];var s,r;if(P.PlotUtils.isClockWise(t,e,o)){s=this.getArrowPoints(t,this.connPoint,this.tempPoint4,false);r=this.getArrowPoints(this.connPoint,e,o,true)}else{s=this.getArrowPoints(e,this.connPoint,o,false);r=this.getArrowPoints(this.connPoint,t,this.tempPoint4,true)}var n=s.length;var l=(n-5)/2;var a=s.slice(0,l);var h=s.slice(l,l+5);var p=s.slice(l+5,n);var c=r.slice(0,l);var u=r.slice(l,l+5);var v=r.slice(l+5,n);c=P.PlotUtils.getBezierPoints(c);var g=P.PlotUtils.getBezierPoints(v.concat(a.slice(1)));p=P.PlotUtils.getBezierPoints(p);var d=c.concat(u,g,h,p);this.setCoordinates([d])},P.Plot.DoubleArrow.prototype.getArrowPoints=function(t,e,o,i){var s=P.PlotUtils.mid(t,e);var r=P.PlotUtils.distance(s,o);var n=P.PlotUtils.getThirdPoint(o,s,0,r*.3,true);var l=P.PlotUtils.getThirdPoint(o,s,0,r*.5,true);n=P.PlotUtils.getThirdPoint(s,n,P.Constants.HALF_PI,r/5,i);l=P.PlotUtils.getThirdPoint(s,l,P.Constants.HALF_PI,r/4,i);var a=[s,n,l,o];var h=this.getArrowHeadPoints(a,this.headHeightFactor,this.headWidthFactor,this.neckHeightFactor,this.neckWidthFactor);var p=h[0];var c=h[4];var u=P.PlotUtils.distance(t,e)/P.PlotUtils.getBaseLength(a)/2;var v=this.getArrowBodyPoints(a,p,c,u);var g=v.length;var d=v.slice(0,g/2);var f=v.slice(g/2,g);d.push(p);f.push(c);d=d.reverse();d.push(e);f=f.reverse();f.push(t);return d.reverse().concat(h,f)},P.Plot.DoubleArrow.prototype.getArrowHeadPoints=function(t,e,o){var i=P.PlotUtils.getBaseLength(t);var s=i*this.headHeightFactor;var r=t[t.length-1];var n=P.PlotUtils.distance(e,o);var l=s*this.headWidthFactor;var a=s*this.neckWidthFactor;var h=s*this.neckHeightFactor;var p=P.PlotUtils.getThirdPoint(t[t.length-2],r,0,s,true);var c=P.PlotUtils.getThirdPoint(t[t.length-2],r,0,h,true);var u=P.PlotUtils.getThirdPoint(r,p,P.Constants.HALF_PI,l,false);var v=P.PlotUtils.getThirdPoint(r,p,P.Constants.HALF_PI,l,true);var g=P.PlotUtils.getThirdPoint(r,c,P.Constants.HALF_PI,a,false);var d=P.PlotUtils.getThirdPoint(r,c,P.Constants.HALF_PI,a,true);return[g,u,r,v,d]},P.Plot.DoubleArrow.prototype.getArrowBodyPoints=function(t,e,o,i){var s=P.PlotUtils.wholeDistance(t);var r=P.PlotUtils.getBaseLength(t);var n=r*i;var l=P.PlotUtils.distance(e,o);var a=(n-l)/2;var h=0,p=[],c=[];for(var u=1;u<t.length-1;u++){var v=P.PlotUtils.getAngleOfThreePoints(t[u-1],t[u],t[u+1])/2;h+=P.PlotUtils.distance(t[u-1],t[u]);var g=(n/2-h/s*a)/Math.sin(v);var d=P.PlotUtils.getThirdPoint(t[u-1],t[u],Math.PI-v,g,true);var f=P.PlotUtils.getThirdPoint(t[u-1],t[u],v,g,false);p.push(d);c.push(f)}return p.concat(c)},P.Plot.DoubleArrow.prototype.getTempPoint4=function(t,e,o){var i=P.PlotUtils.mid(t,e);var s=P.PlotUtils.distance(i,o);var r=P.PlotUtils.getAngleOfThreePoints(t,i,o);var n,l,a,h;if(r<P.Constants.HALF_PI){l=s*Math.sin(r);a=s*Math.cos(r);h=P.PlotUtils.getThirdPoint(t,i,P.Constants.HALF_PI,l,false);n=P.PlotUtils.getThirdPoint(i,h,P.Constants.HALF_PI,a,true)}else if(r>=P.Constants.HALF_PI&&r<Math.PI){l=s*Math.sin(Math.PI-r);a=s*Math.cos(Math.PI-r);h=P.PlotUtils.getThirdPoint(t,i,P.Constants.HALF_PI,l,false);n=P.PlotUtils.getThirdPoint(i,h,P.Constants.HALF_PI,a,false)}else if(r>=Math.PI&&r<Math.PI*1.5){l=s*Math.sin(r-Math.PI);a=s*Math.cos(r-Math.PI);h=P.PlotUtils.getThirdPoint(t,i,P.Constants.HALF_PI,l,true);n=P.PlotUtils.getThirdPoint(i,h,P.Constants.HALF_PI,a,true)}else{l=s*Math.sin(Math.PI*2-r);a=s*Math.cos(Math.PI*2-r);h=P.PlotUtils.getThirdPoint(t,i,P.Constants.HALF_PI,l,true);n=P.PlotUtils.getThirdPoint(i,h,P.Constants.HALF_PI,a,false)}return n},P.Plot.Ellipse=function(t){goog.base(this,[]);this.type=P.PlotTypes.ELLIPSE;this.fixPointCount=2;this.setPoints(t)},goog.inherits(P.Plot.Ellipse,ol.geom.Polygon),goog.mixin(P.Plot.Ellipse.prototype,P.Plot.prototype),P.Plot.Ellipse.prototype.generate=function(){if(this.getPointCount()<2)return;var t=this.points[0];var e=this.points[1];var o=P.PlotUtils.mid(t,e);var i=Math.abs((t[0]-e[0])/2);var s=Math.abs((t[1]-e[1])/2);this.setCoordinates([this.generatePoints(o,i,s)])},P.Plot.Ellipse.prototype.generatePoints=function(t,e,o){var i,s,r,n=[];for(var l=0;l<=P.Constants.FITTING_COUNT;l++){r=Math.PI*2*l/P.Constants.FITTING_COUNT;i=t[0]+e*Math.cos(r);s=t[1]+o*Math.sin(r);n.push([i,s])}return n},P.Plot.FineArrow=function(t){goog.base(this,[]);this.type=P.PlotTypes.FINE_ARROW;this.tailWidthFactor=.15;this.neckWidthFactor=.2;this.headWidthFactor=.25;this.headAngle=Math.PI/8.5;this.neckAngle=Math.PI/13;this.fixPointCount=2;this.setPoints(t)},goog.inherits(P.Plot.FineArrow,ol.geom.Polygon),goog.mixin(P.Plot.FineArrow.prototype,P.Plot.prototype),P.Plot.FineArrow.prototype.generate=function(){var t=this.getPoints();var e=t[0];var o=t[1];var i=P.PlotUtils.getBaseLength(t);var s=i*this.tailWidthFactor;var r=i*this.neckWidthFactor;var n=i*this.headWidthFactor;var l=P.PlotUtils.getThirdPoint(o,e,P.Constants.HALF_PI,s,true);var a=P.PlotUtils.getThirdPoint(o,e,P.Constants.HALF_PI,s,false);var h=P.PlotUtils.getThirdPoint(e,o,this.headAngle,n,false);var p=P.PlotUtils.getThirdPoint(e,o,this.headAngle,n,true);var c=P.PlotUtils.getThirdPoint(e,o,this.neckAngle,r,false);var u=P.PlotUtils.getThirdPoint(e,o,this.neckAngle,r,true);var v=[l,c,h,o,p,u,a];this.setCoordinates([v])},P.Plot.AssaultDirection=function(t){goog.base(this,[]);this.type=P.PlotTypes.ASSAULT_DIRECTION;this.tailWidthFactor=.2;this.neckWidthFactor=.25;this.headWidthFactor=.3;this.headAngle=Math.PI/4;this.neckAngle=Math.PI*.17741;this.setPoints(t)},goog.inherits(P.Plot.AssaultDirection,P.Plot.FineArrow),P.Plot.GatheringPlace=function(t){goog.base(this,[]);this.type=P.PlotTypes.GATHERING_PLACE;this.t=.4;this.fixPointCount=3;this.setPoints(t)},goog.inherits(P.Plot.GatheringPlace,ol.geom.Polygon),goog.mixin(P.Plot.GatheringPlace.prototype,P.Plot.prototype),P.Plot.GatheringPlace.prototype.generate=function(){var t=this.getPoints();if(t.length<2)return;if(this.getPointCount()==2){var e=P.PlotUtils.mid(t[0],t[1]);var o=P.PlotUtils.distance(t[0],e)/.9;var i=P.PlotUtils.getThirdPoint(t[0],e,P.Constants.HALF_PI,o,true);t=[t[0],i,t[1]]}var e=P.PlotUtils.mid(t[0],t[2]);t.push(e,t[0],t[1]);var s=[];for(var r=0;r<t.length-2;r++){var n=t[r];var l=t[r+1];var a=t[r+2];var h=P.PlotUtils.getBisectorNormals(this.t,n,l,a);s=s.concat(h)}var p=s.length;s=[s[p-1]].concat(s.slice(0,p-1));var c=[];for(r=0;r<t.length-2;r++){n=t[r];l=t[r+1];c.push(n);for(var u=0;u<=P.Constants.FITTING_COUNT;u++){var i=P.PlotUtils.getCubicValue(u/P.Constants.FITTING_COUNT,n,s[r*2],s[r*2+1],l);c.push(i)}c.push(l)}this.setCoordinates([c])},P.Plot.Lune=function(t){goog.base(this,[]);this.type=P.PlotTypes.LUNE;this.fixPointCount=3;this.setPoints(t)},goog.inherits(P.Plot.Lune,ol.geom.Polygon),goog.mixin(P.Plot.Lune.prototype,P.Plot.prototype),P.Plot.Lune.prototype.generate=function(){if(this.getPointCount()<2)return;var t=this.getPoints();if(this.getPointCount()==2){var e=P.PlotUtils.mid(t[0],t[1]);var o=P.PlotUtils.distance(t[0],e);var i=P.PlotUtils.getThirdPoint(t[0],e,P.Constants.HALF_PI,o);t.push(i)}var s=t[0];var r=t[1];var n=t[2];var l=P.PlotUtils.getCircleCenterOfThreePoints(s,r,n);var a=P.PlotUtils.distance(s,l);var h=P.PlotUtils.getAzimuth(s,l);var p=P.PlotUtils.getAzimuth(r,l);if(P.PlotUtils.isClockWise(s,r,n)){var c=p;var u=h}else{c=h;u=p}var t=P.PlotUtils.getArcPoints(l,a,c,u);t.push(t[0]);this.setCoordinates([t])},P.Plot.Sector=function(t){goog.base(this,[]);this.type=P.PlotTypes.SECTOR;this.fixPointCount=3;this.setPoints(t)},goog.inherits(P.Plot.Sector,ol.geom.Polygon),goog.mixin(P.Plot.Sector.prototype,P.Plot.prototype),P.Plot.Sector.prototype.generate=function(){if(this.getPointCount()<2)return;if(this.getPointCount()==2)this.setCoordinates([this.points]);else{var t=this.getPoints();var e=t[0];var o=t[1];var i=t[2];var s=P.PlotUtils.distance(o,e);var r=P.PlotUtils.getAzimuth(o,e);var n=P.PlotUtils.getAzimuth(i,e);var l=P.PlotUtils.getArcPoints(e,s,r,n);l.push(e,l[0]);this.setCoordinates([l])}},P.Plot.StraightArrow=function(t){goog.base(this,[]);this.type=P.PlotTypes.STRAIGHT_ARROW;this.fixPointCount=2;this.maxArrowLength=3e6;this.arrowLengthScale=5;this.setPoints(t)},goog.inherits(P.Plot.StraightArrow,ol.geom.LineString),goog.mixin(P.Plot.StraightArrow.prototype,P.Plot.prototype),P.Plot.StraightArrow.prototype.generate=function(){if(this.getPointCount()<2)return;var t=this.getPoints();var e=t[0];var o=t[1];var i=P.PlotUtils.distance(e,o);var s=i/this.arrowLengthScale;s=s>this.maxArrowLength?this.maxArrowLength:s;var r=P.PlotUtils.getThirdPoint(e,o,Math.PI/6,s,false);var n=P.PlotUtils.getThirdPoint(e,o,Math.PI/6,s,true);this.setCoordinates([e,o,r,o,n])},P.Plot.Polyline=function(t){goog.base(this,[]);this.type=P.PlotTypes.POLYLINE;this.setPoints(t)},goog.inherits(P.Plot.Polyline,ol.geom.LineString),goog.mixin(P.Plot.Polyline.prototype,P.Plot.prototype),P.Plot.Polyline.prototype.generate=function(){this.setCoordinates(this.points)},P.Plot.FreehandLine=function(t){goog.base(this,[]);this.type=P.PlotTypes.FREEHAND_LINE;this.freehand=true;this.setPoints(t)},goog.inherits(P.Plot.FreehandLine,ol.geom.LineString),goog.mixin(P.Plot.FreehandLine.prototype,P.Plot.prototype),P.Plot.FreehandLine.prototype.generate=function(){this.setCoordinates(this.points)},P.Plot.Polygon=function(t){goog.base(this,[]);this.type=P.PlotTypes.POLYGON;this.setPoints(t)},goog.inherits(P.Plot.Polygon,ol.geom.Polygon),goog.mixin(P.Plot.Polygon.prototype,P.Plot.prototype),P.Plot.Polygon.prototype.generate=function(){this.setCoordinates([this.points])},P.Plot.FreehandPolygon=function(t){goog.base(this,[]);this.type=P.PlotTypes.FREEHAND_POLYGON;this.freehand=true;this.setPoints(t)},goog.inherits(P.Plot.FreehandPolygon,ol.geom.Polygon),goog.mixin(P.Plot.FreehandPolygon.prototype,P.Plot.prototype),P.Plot.FreehandPolygon.prototype.generate=function(){this.setCoordinates([this.points])},P.Plot.Rectangle=function(t){goog.base(this,[]);this.type=P.PlotTypes.RECTANGLE;this.fixPointCount=2;this.setPoints(t)},goog.inherits(P.Plot.Rectangle,ol.geom.Polygon),goog.mixin(P.Plot.Rectangle.prototype,P.Plot.prototype),P.Plot.Rectangle.prototype.generate=function(){var t=this.getPointCount();if(t<2){return}else{var e=this.points[0];var o=this.points[1];var i=Math.min(e[0],o[0]);var s=Math.max(e[0],o[0]);var r=Math.min(e[1],o[1]);var n=Math.max(e[1],o[1]);var l=[i,n];var a=[s,n];var P=[s,r];var h=[i,r];this.setCoordinates([[l,a,P,h]])}},P.PlotFactory={},P.PlotFactory.createPlot=function(t,e){switch(t){case P.PlotTypes.ARC:return new P.Plot.Arc(e);case P.PlotTypes.ELLIPSE:return new P.Plot.Ellipse(e);case P.PlotTypes.CURVE:return new P.Plot.Curve(e);case P.PlotTypes.CLOSED_CURVE:return new P.Plot.ClosedCurve(e);case P.PlotTypes.LUNE:return new P.Plot.Lune(e);case P.PlotTypes.SECTOR:return new P.Plot.Sector(e);case P.PlotTypes.GATHERING_PLACE:return new P.Plot.GatheringPlace(e);case P.PlotTypes.STRAIGHT_ARROW:return new P.Plot.StraightArrow(e);case P.PlotTypes.ASSAULT_DIRECTION:return new P.Plot.AssaultDirection(e);case P.PlotTypes.ATTACK_ARROW:return new P.Plot.AttackArrow(e);case P.PlotTypes.FINE_ARROW:return new P.Plot.FineArrow(e);case P.PlotTypes.CIRCLE:return new P.Plot.Circle(e);case P.PlotTypes.DOUBLE_ARROW:return new P.Plot.DoubleArrow(e);case P.PlotTypes.TAILED_ATTACK_ARROW:return new P.Plot.TailedAttackArrow(e);case P.PlotTypes.SQUAD_COMBAT:return new P.Plot.SquadCombat(e);case P.PlotTypes.TAILED_SQUAD_COMBAT:return new P.Plot.TailedSquadCombat(e);case P.PlotTypes.FREEHAND_LINE:return new P.Plot.FreehandLine(e);case P.PlotTypes.FREEHAND_POLYGON:return new P.Plot.FreehandPolygon(e);case P.PlotTypes.POLYGON:
return new P.Plot.Polygon(e);case P.PlotTypes.POLYLINE:return new P.Plot.Polyline(e);case P.PlotTypes.RECTANGLE:return new P.Plot.Rectangle(e)}return null},P.PlotDraw=function(t,e){goog.base(this,[]);this.points=null;this.plot=null;this.feature=null;this.plotType=null;this.plotParams=null;this.mapViewport=null;this.resultOverlay=null;this.dblClickZoomInteraction=null;this.helpTipMsg="";this.helpTipElement=null;this.helpTipOverlay=null;var o=new ol.style.Stroke({color:"#8a2be2",width:1});var i=new ol.style.Fill({color:"rgba(0,0,255,0.4)"});if(e){for(attr in e){if(attr==="stroke"){for(subAtrr in e.stroke){if(subAtrr==="color"){o.setColor(e.stroke["color"])}if(subAtrr==="width"){o.setWidth(e.stroke["width"])}}}if(attr==="fill"){for(subAtrr in e.fill){if(subAtrr==="color"){i.setColor(e.fill["color"])}}}}}this.style=new ol.style.Style({fill:i,stroke:o});this.featureSource=new ol.source.Vector;this.drawOverlay=new ol.layer.Vector({source:this.featureSource});this.drawOverlay.setStyle(this.style);this.setMap(t);this.updateClass=this.updateClass.bind(this);this.onMouseMove=this.onMouseMove.bind(this)},goog.inherits(P.PlotDraw,ol.Observable),P.PlotDraw.prototype.addFeature=function(t,e){if(t){if(this.resultOverlay){var o=null;if(e){var i=new ol.style.Stroke({color:"rgba(0,100,0,1)",width:1});var s=new ol.style.Fill({color:"rgba(0,100,0,0.4)"});o=new ol.style.Style({fill:s,stroke:i});for(attr in e){if(attr==="stroke"){for(subAtrr in e.stroke){if(subAtrr==="color"){i.setColor(e.stroke["color"])}if(subAtrr==="width"){i.setWidth(e.stroke["width"])}}}if(attr==="fill"){for(subAtrr in e.fill){if(subAtrr==="color"){s.setColor(e.fill["color"])}}}}}if(t instanceof ol.Feature){if(e){t.setStyle(o)}this.resultOverlay.getSource().addFeature(t)}else{if(t instanceof P.Plot.FineArrow||t instanceof ol.geom.Polygon||t instanceof ol.geom.LineString){t=new ol.Feature(t);if(e){t.setStyle(o)}this.resultOverlay.getSource().addFeature(t)}else{if(console){console.log("参数类型不正确")}}}}}},P.PlotDraw.prototype.removeFeature=function(t){if(this.resultOverlay){if(t){if(t instanceof ol.Feature){this.resultOverlay.getSource().removeFeature(t)}if(t instanceof P.Plot.FineArrow||t instanceof ol.geom.Polygon||t instanceof ol.geom.LineString){t=new ol.Feature(t);this.resultOverlay.getSource().removeFeature(t)}if(this.mapViewport){this.mapViewport.style.cursor="default"}}}},P.PlotDraw.prototype.onAdd=function(t){if(!this.map){this.setMap(t)}else{if(!this.resultOverlay){var e=new ol.style.Stroke({color:"rgba(0,255,0,1)",width:1});var o=new ol.style.Fill({color:"rgba(0,255,0,0.3)"});var i=new ol.style.Style({fill:o,stroke:e});var s=new ol.layer.Vector({source:new ol.source.Vector});s.setStyle(i);s.set("name","P.result");var r=t.getCustomLayers();r.getLayers().push(s);this.resultOverlay=s;return s}}},P.PlotDraw.prototype.onRemove=function(){if(this.resultOverlay){this.resultOverlay=null;if(this.map){var t=this.map.getCustomLayers();var e=t.getLayers();e.remove(this.resultOverlay)}}},P.PlotDraw.prototype.addPlotEventListener=function(t,e){if(t=="draw_end"){this.on(P.Event.PlotDrawEvent.DRAW_END,e,false,this)}if(t=="draw_start"){this.on(P.Event.PlotDrawEvent.DRAW_START,e,false,this)}},P.PlotDraw.prototype.removePlotEventListener=function(t,e){if(t=="draw_end"){this.un(P.Event.PlotDrawEvent.DRAW_END,e,false,this)}if(t=="draw_start"){this.un(P.Event.PlotDrawEvent.DRAW_START,e,false,this)}},P.PlotDraw.prototype.updateClass=function(t){ol.interaction.Draw2.addClass(this.helpTipElement,"hidden")},P.PlotDraw.prototype.activate=function(t,e){this.deactivate();this.deactivateMapTools();this.map.on("click",this.mapFirstClickHandler,this);this.plotType=t;this.plotParams=e;this.helpTipMsg="单击开始绘图";this.initElement();this.mapViewport.addEventListener("mouseout",this.updateClass);this.map.on("pointermove",this.onMouseMove);this.map.addLayer(this.drawOverlay,true)},P.PlotDraw.prototype.onMouseMove=function(t){var e=t.pixel?t.pixel:[t.clientX,t.clientY];var o=this.map.getCoordinateFromPixel(e);if(this.helpTipOverlay){this.helpTipOverlay.setPosition(o)}},P.PlotDraw.prototype.updateMsg=function(t){var e=this.plot.getPointCount();if(e>3){e="@"}switch(t+"_"+e){case P.PlotTypes.GATHERING_PLACE+"_"+1:this.helpTipElement.innerHTML="单击确定另一个顶点";break;case P.PlotTypes.GATHERING_PLACE+"_"+2:this.helpTipElement.innerHTML="单击结束绘制";break;case P.PlotTypes.ARC+"_"+1:this.helpTipElement.innerHTML="单击确定另一个顶点";break;case P.PlotTypes.ARC+"_"+2:this.helpTipElement.innerHTML="移动确定弧形，单击结束绘制";break;case P.PlotTypes.ATTACK_ARROW+"_"+1:this.helpTipElement.innerHTML="单击确定底座顶点";break;case P.PlotTypes.ATTACK_ARROW+"_"+2:this.helpTipElement.innerHTML="单击确定路径，双击结束绘制";break;case P.PlotTypes.ATTACK_ARROW+"_"+3:this.helpTipElement.innerHTML="单击确定路径，双击结束绘制";break;case P.PlotTypes.ATTACK_ARROW+"_@":this.helpTipElement.innerHTML="单击确定路径，双击结束绘制";break;case P.PlotTypes.DOUBLE_ARROW+"_"+1:this.helpTipElement.innerHTML="单击确定底座顶点";break;case P.PlotTypes.DOUBLE_ARROW+"_"+2:this.helpTipElement.innerHTML="单击确定箭头目标位置";break;case P.PlotTypes.DOUBLE_ARROW+"_"+3:this.helpTipElement.innerHTML="单击结束绘制";break}},P.PlotDraw.prototype.initElement=function(){if(this.helpTipElement){this.helpTipElement.parentNode.removeChild(this.helpTipElement)}this.helpTipElement=document.createElement("div");this.helpTipElement.id="ez-tip-helper";this.helpTipElement.className="tooltip hidden";this.helpTipOverlay=new ol.Overlay({element:this.helpTipElement,offset:[15,0],stopEvent:true,positioning:"center-left"});this.helpTipElement.innerHTML=this.helpTipMsg;this.map.addOverlay(this.helpTipOverlay,true)},P.PlotDraw.prototype.deactivate=function(){this.disconnectEventHandlers();this.map.removeLayer(this.drawOverlay,true);this.featureSource.clear();this.points=[];this.plot=null;this.feature=null;this.plotType=null;this.plotParams=null;this.activateMapTools();this.map.removeOverlay(this.helpTipOverlay,true);this.helpTipOverlay=null;this.mapViewport.removeEventListener("mouseout",this.updateClass)},P.PlotDraw.prototype.isDrawing=function(){return this.plotType!=null},P.PlotDraw.prototype.setMap=function(t){this.map=t;this.mapViewport=this.map.getViewport()},P.PlotDraw.prototype.mapFirstClickHandler=function(t){this.dispatchEvent(new P.Event.PlotDrawEvent(P.Event.PlotDrawEvent.DRAW_START,this));this.points.push(t.coordinate);this.plot=P.PlotFactory.createPlot(this.plotType,this.points,this.plotParams);this.feature=new ol.Feature(this.plot);this.featureSource.addFeature(this.feature);this.map.un("click",this.mapFirstClickHandler,this);this.map.un("pointermove",this.onMouseMove);this.map.on("click",this.mapNextClickHandler,this);this.updateMsg(this.plotType);if(!this.plot.freehand){this.map.on("dblclick",this.mapDoubleClickHandler,this)}ol.events.listen(this.mapViewport,P.Event.EventType.MOUSEMOVE,this.mapMouseMoveHandler,this)},P.PlotDraw.prototype.mapMouseMoveHandler=function(t){if(t.target.id==="ez-tip-helper")return;var e=map.getCoordinateFromPixel([t.offsetX,t.offsetY]);if(P.PlotUtils.distance(e,this.points[this.points.length-1])<P.Constants.ZERO_TOLERANCE)return;if(!this.plot.freehand){var o=this.points.concat([e]);this.plot.setPoints(o)}else{this.points.push(e);this.plot.setPoints(this.points)}this.helpTipOverlay.setPosition(e)},P.PlotDraw.prototype.mapNextClickHandler=function(t){if(!this.plot.freehand){if(P.PlotUtils.distance(t.coordinate,this.points[this.points.length-1])<P.Constants.ZERO_TOLERANCE)return}this.points.push(t.coordinate);this.plot.setPoints(this.points);this.updateMsg(this.plotType);if(this.plot.fixPointCount==this.plot.getPointCount()){this.mapDoubleClickHandler(t)}if(this.plot&&this.plot.freehand){this.mapDoubleClickHandler(t)}},P.PlotDraw.prototype.mapDoubleClickHandler=function(t){this.disconnectEventHandlers();this.plot.finishDrawing();t.preventDefault();this.drawEnd()},P.PlotDraw.prototype.disconnectEventHandlers=function(){this.map.un("click",this.mapFirstClickHandler,this);this.map.un("click",this.mapNextClickHandler,this);ol.events.unlisten(this.mapViewport,P.Event.EventType.MOUSEMOVE,this.mapMouseMoveHandler,this);this.map.un("dblclick",this.mapDoubleClickHandler,this)},P.PlotDraw.prototype.drawEnd=function(t){this.featureSource.removeFeature(this.feature);this.activateMapTools();this.disconnectEventHandlers();this.map.removeOverlay(this.drawOverlay,true);this.dispatchEvent(new P.Event.PlotDrawEvent(P.Event.PlotDrawEvent.DRAW_END,this));this.feature=null;this.points=[];this.plot=null;this.plotType=null;this.plotParams=null;this.map.removeOverlay(this.helpTipOverlay,true);this.helpTipOverlay=null;this.mapViewport.removeEventListener("mouseout",this.updateClass)},P.PlotDraw.prototype.deactivateMapTools=function(){var t=map.getInteractions();var e=t.getLength();for(var o=0;o<e;o++){var i=t.item(o);if(i instanceof ol.interaction.DoubleClickZoom){this.dblClickZoomInteraction=i;t.remove(i);break}}},P.PlotDraw.prototype.activateMapTools=function(){if(this.dblClickZoomInteraction!=null){map.getInteractions().push(this.dblClickZoomInteraction);this.dblClickZoomInteraction=null}},P.PlotEdit=function(t){if(!t){return}goog.base(this,[]);this.activePlot=null;this.startPoint=null;this.ghostControlPoints=null;this.controlPoints=null;this.map=t;this.mapViewport=this.map.getViewport();this.mouseOver=false;this.elementTable={};this.activeControlPointId=null;this.mapDragPan=null;this.dx=0;this.dy=0;this.controPointStatus=false},goog.inherits(P.PlotEdit,ol.Observable),P.PlotEdit.prototype.Constants={HELPER_HIDDEN_DIV:"p-helper-hidden-div",HELPER_CONTROL_POINT_DIV:"p-helper-control-point-div"},P.PlotEdit.prototype.initHelperDom=function(){if(!this.map||!this.activePlot){return}var t=this.getMapParentElement();if(!t){return}var e=P.DomUtils.createHidden("div",t,this.Constants.HELPER_HIDDEN_DIV);var o=this.getControlPoints();for(var i=0;i<o.length;i++){var s=this.Constants.HELPER_CONTROL_POINT_DIV+"-"+i;P.DomUtils.create("div",this.Constants.HELPER_CONTROL_POINT_DIV,e,s);this.elementTable[s]=i}},P.PlotEdit.prototype.getMapParentElement=function(){var t=this.map.getTargetElement();if(!t){return}return t.parentNode},P.PlotEdit.prototype.destroyHelperDom=function(){if(this.controlPoints){for(var t=0;t<this.controlPoints.length;t++){this.map.removeOverlay(this.controlPoints[t],true);var e=P.DomUtils.get(this.Constants.HELPER_CONTROL_POINT_DIV+"-"+t);if(e){P.DomUtils.removeListener(e,"mousedown",this.controlPointMouseDownHandler,this);P.DomUtils.removeListener(e,"mousemove",this.controlPointMouseMoveHandler2,this)}}this.controlPoints=null}var o=this.getMapParentElement();var i=P.DomUtils.get(this.Constants.HELPER_HIDDEN_DIV);if(i&&o){P.DomUtils.remove(i,o)}},P.PlotEdit.prototype.initControlPoints=function(){if(!this.map){return}this.controlPoints=[];var t=this.getControlPoints();for(var e=0;e<t.length;e++){var o=this.Constants.HELPER_CONTROL_POINT_DIV+"-"+e;var i=P.DomUtils.get(o);var s=new ol.Overlay({id:o,position:t[e],positioning:"center-center",element:i});this.controlPoints.push(s);s.setPositioning("center-center");this.map.addOverlay(s,true);P.DomUtils.addListener(i,"mousedown",this.controlPointMouseDownHandler,this);P.DomUtils.addListener(i,"mousemove",this.controlPointMouseMoveHandler2,this);P.DomUtils.addListener(i,"mouseup",this.controlPointsMouseUpHandler,this)}},P.PlotEdit.prototype.addPlotEventListener=function(t,e){if(t=="edit_end"){this.on(P.Event.PlotEditEvent.EDIT_END,e,false,this)}if(t=="edit_start"){this.on(P.Event.PlotEditEvent.EDIT_START,e,false,this)}},P.PlotEdit.prototype.removePlotEventListener=function(t,e){if(t=="edit_end"){this.un(P.Event.PlotEditEvent.EDIT_END,e,false,this)}if(t=="edit_start"){this.un(P.Event.PlotEditEvent.EDIT_START,e,false,this)}},P.PlotEdit.prototype.controlPointsMouseUpHandler=function(t){if(this.controPointStatus){this.controPointStatus=false;this.dispatchEvent(new P.Event.PlotEditEvent(P.Event.PlotEditEvent.EDIT_END,this))}},P.PlotEdit.prototype.controlPointMouseMoveHandler2=function(t){t.stopImmediatePropagation()},P.PlotEdit.prototype.controlPointMouseDownHandler=function(t){var e=t.target.id;this.activeControlPointId=e;ol.events.listen(this.mapViewport,P.Event.EventType.MOUSEMOVE,this.controlPointMouseMoveHandler,this);ol.events.listen(this.mapViewport,P.Event.EventType.MOUSEUP,this.controlPointMouseUpHandler,this)},P.PlotEdit.prototype.controlPointMouseMoveHandler=function(t){if(t.offsetX!=0||t.offsetY!=0){this.controPointStatus=true}var e=map.getCoordinateFromPixel([t.offsetX,t.offsetY]);if(this.activeControlPointId){var o=this.activePlot.getGeometry();var i=this.elementTable[this.activeControlPointId];o.updatePoint(e,i);var s=this.map.getOverlayById(this.activeControlPointId);s.setPosition(e);s.setPositioning("center-center")}},P.PlotEdit.prototype.controlPointMouseUpHandler=function(t){ol.events.unlisten(this.mapViewport,P.Event.EventType.MOUSEMOVE,this.controlPointMouseMoveHandler,this);ol.events.unlisten(this.mapViewport,P.Event.EventType.MOUSEUP,this.controlPointMouseUpHandler,this)},P.PlotEdit.prototype.activate=function(t){if(!t||!(t instanceof ol.Feature)||t==this.activePlot){return}var e=t.getGeometry();if(!e.isPlot){return}if(!e.isPlot()){return}this.deactivate();this.activePlot=t;this.map.on("pointermove",this.plotMouseOverOutHandler,this);this.initHelperDom();this.initControlPoints();this.dispatchEvent(new P.Event.PlotEditEvent(P.Event.PlotEditEvent.EDIT_START,this))},P.PlotEdit.prototype.getControlPoints=function(){if(!this.activePlot){return[]}var t=this.activePlot.getGeometry();return t.getPoints()},P.PlotEdit.prototype.plotMouseOverOutHandler=function(t){var e=map.forEachFeatureAtPixel(t.pixel,function(t,e){return t});if(e&&e==this.activePlot){if(!this.mouseOver){this.mouseOver=true;this.map.getViewport().style.cursor="move";this.map.on("pointerdown",this.plotMouseDownHandler,this)}}else{if(this.mouseOver){this.mouseOver=false;this.map.getViewport().style.cursor="default";this.map.un("pointerdown",this.plotMouseDownHandler,this)}}},P.PlotEdit.prototype.plotMouseDownHandler=function(t){this.ghostControlPoints=this.getControlPoints();this.startPoint=t.coordinate;this.disableMapDragPan();this.map.on("pointerup",this.plotMouseUpHandler,this);this.map.on("pointerdrag",this.plotMouseMoveHandler,this)},P.PlotEdit.prototype.plotMouseMoveHandler=function(t){var e=t.coordinate;var o=e[0]-this.startPoint[0];var i=e[1]-this.startPoint[1];this.dx=o;this.dy=i;var s=[];for(var r=0;r<this.ghostControlPoints.length;r++){var n=this.ghostControlPoints[r];var l=[n[0]+o,n[1]+i];s.push(l);var a=this.Constants.HELPER_CONTROL_POINT_DIV+"-"+r;var P=this.map.getOverlayById(a);P.setPositioning("center-center");P.setPosition(l)}var h=this.activePlot.getGeometry();h.setPoints(s)},P.PlotEdit.prototype.plotMouseUpHandler=function(t){if(this.dx!=0||this.dy!=0){this.dispatchEvent(new P.Event.PlotEditEvent(P.Event.PlotEditEvent.EDIT_END,this))}this.dx=0;this.dy=0;this.enableMapDragPan();this.map.un("pointerup",this.plotMouseUpHandler,this);this.map.un("pointerdrag",this.plotMouseMoveHandler,this)},P.PlotEdit.prototype.disconnectEventHandlers=function(){this.map.un("pointermove",this.plotMouseOverOutHandler,this);ol.events.unlisten(this.mapViewport,P.Event.EventType.MOUSEMOVE,this.controlPointMouseMoveHandler,this);ol.events.unlisten(this.mapViewport,P.Event.EventType.MOUSEUP,this.controlPointMouseUpHandler,this);this.map.un("pointerdown",this.plotMouseDownHandler,this);this.map.un("pointerup",this.plotMouseUpHandler,this);this.map.un("pointerdrag",this.plotMouseMoveHandler,this)},P.PlotEdit.prototype.deactivate=function(){this.activePlot=null;this.mouseOver=false;this.destroyHelperDom();this.disconnectEventHandlers();this.elementTable={};this.activeControlPointId=null;this.startPoint=null},P.PlotEdit.prototype.disableMapDragPan=function(){var t=this.map.getInteractions();var e=t.getLength();for(var o=0;o<e;o++){var i=t.item(o);if(i instanceof ol.interaction.DragPan){this.mapDragPan=i;i.setActive(false);break}}},P.PlotEdit.prototype.enableMapDragPan=function(){if(this.mapDragPan!=null){this.mapDragPan.setActive(true);this.mapDragPan=null}};